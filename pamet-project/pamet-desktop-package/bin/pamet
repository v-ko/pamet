#!/usr/bin/env python

import os
import signal

from misli_debug import set_logging_level, LoggingLevels
set_logging_level(LoggingLevels.DEBUG)

import misli
from pamet.services.file_system_storage import FSStorageRepository

import misli_gui
from pamet import update_components_from_changes

from pamet import usecases
from pamet_desktop.qt_main_loop import QtMainLoop
from pamet_desktop.config import get_config

log = misli.get_logger(__name__)
signal.signal(signal.SIGINT, signal.SIG_DFL)


def main():
    config = get_config()
    repo_path = config['repository_path']

    # # Testing - restore repo changes
    # for f in os.scandir(repo_path):
    #     if f.name.endswith('backup'):
    #         os.rename(f.path, f.path[:-7])

    #     if f.name.endswith('misl.json'):
    #         os.remove(f.path)

    if os.path.exists(repo_path):
        fs_repo = FSStorageRepository.open(repo_path)
    else:
        fs_repo = FSStorageRepository.create(repo_path)

    if not fs_repo:
        log.error('Error initializing repository. Exiting.')
        return

    misli.set_repo(fs_repo, 'all')
    misli.set_main_loop(QtMainLoop())
    misli.subscribe(update_components_from_changes, channel='all')

    misli.line_spacing_in_pixels = 20

    desktop_app = misli_gui.create_component('DesktopApp', parent_id='')
    usecases.new_browser_window_ensure_page()
    desktop_app.exec_()


if __name__ == '__main__':
    main()
